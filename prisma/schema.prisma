// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum LeadStatus {
  NEW
  CONTACTED
  SCHEDULED
  COMPLETED
  ARCHIVED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskRecurrence {
  NONE
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum JobStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  DONE
  INVOICED
  PAID
  CANCELED
}

enum ServicePlanStatus {
  ACTIVE
  PAUSED
  CANCELED
}

enum ServicePlanFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum PaymentMethod {
  CASH
  CHECK
  CARD
  ACH
  OTHER
}

enum InvoiceNoteChannel {
  CALL
  TEXT
  EMAIL
  IN_PERSON
  OTHER
}

enum ExpenseCategory {
  MATERIALS
  FUEL
  EQUIPMENT
  REPAIRS
  SUBCONTRACTOR
  LABOR
  MARKETING
  SOFTWARE
  INSURANCE
  FEES
  OTHER
}

enum ClientUserRole {
  OWNER
  MEMBER
}

enum PaymentStatus {
  CREATED
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
}

// --- INVITES + STAFF (EMPLOYEES) ---

enum InviteKind {
  CLIENT_PORTAL
  STAFF
}

enum StaffRole {
  ADMIN
  STAFF
}

model ClientInvite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  acceptedAt DateTime?

  kind InviteKind @default(CLIENT_PORTAL)

  // Who is invited
  email String

  // Token in URL
  token     String   @unique
  expiresAt DateTime

  // Target client + role
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  role ClientUserRole @default(OWNER)

  // Audit
  createdByUserId String?

  @@index([clientId])
  @@index([email])
  @@index([expiresAt])
}

model StaffUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  clerkUserId String @unique

  role StaffRole @default(STAFF)

  // Optional: fine-grained permissions later
  // TODO: Replace with a real permissions table if needed
  permissionsJson String?

  @@index([role])
}

model StaffInvite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  acceptedAt DateTime?

  kind InviteKind @default(STAFF)

  email String

  token     String   @unique
  expiresAt DateTime

  role StaffRole @default(STAFF)

  createdByUserId String?

  @@index([email])
  @@index([expiresAt])
}

model Lead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name    String
  email   String?
  phone   String
  address String?
  city    String?
  state   String?
  zip     String?

  service String?
  message String

  status LeadStatus @default(NEW)

  sourceUrl String?

  customerUserId String?

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  notes LeadNote[]
  tasks Task[]
  jobs  Job[]

  @@index([createdAt])
  @@index([status])
  @@index([customerUserId])
  @@index([email])
  @@index([clientId])
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  authorId  String?
  body      String
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdAt])
}

model Task {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title    String
  body     String?
  dueAt    DateTime
  priority TaskPriority @default(MEDIUM)

  completedAt DateTime?

  recurrence TaskRecurrence @default(NONE)

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  createdByUserId String?

  @@index([dueAt])
  @@index([completedAt])
  @@index([priority])
  @@index([leadId])
  @@index([clientId])
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name  String
  email String?
  phone String?

  tags  String?
  notes String?

  // ✅ Stripe
  stripeCustomerId String? @unique

  leads        Lead[]
  addresses    ClientAddress[]
  tasks        Task[]
  jobs         Job[]
  servicePlans ServicePlan[]
  expenses     Expense[]
  users        ClientUser[]
  invites ClientInvite[]

  // ✅ Saved cards
  paymentMethods ClientPaymentMethod[]

  autopayEnabled Boolean @default(false) // ✅ autopay toggle (MVP)
  // TODO: Add autopay rules later (charge on issue vs due date, retry rules, day/time windows), add autopay failed state + last attempt timestamps later .

  @@index([createdAt])
  @@index([name])
  @@index([email])
  @@index([phone])
}

model ClientPaymentMethod {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  stripePaymentMethodId String @unique

  brand    String?
  last4    String?
  expMonth Int?
  expYear  Int?

  isDefault Boolean @default(false)

  // TODO: Add billing details (name, zip) later if needed.

  @@index([clientId])
  @@index([isDefault])
}

model ClientAddress {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  label    String?
  address  String
  city     String?
  state    String?
  zip      String?
  gateCode String?
  notes    String?

  isPrimary Boolean @default(false)

  jobs         Job[]
  servicePlans ServicePlan[]

  @@index([clientId])
  @@index([isPrimary])
}

model ClientUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  clerkUserId String @unique

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  role ClientUserRole @default(OWNER)

  @@index([clientId])
}

model Job {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status JobStatus @default(DRAFT)

  title String
  notes String?

  scheduledStart DateTime?
  scheduledEnd   DateTime?

  estimatedPriceCents Int?
  actualPriceCents    Int?

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  addressId String?
  address   ClientAddress? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  servicePlanId String?
  servicePlan   ServicePlan? @relation(fields: [servicePlanId], references: [id], onDelete: SetNull)
  // TODO: Invoicing model will likely need a different dedupe key (occurrenceId / rruleseq) later.

  invoice Invoice?

  expenses Expense[]

  @@unique([servicePlanId, scheduledStart])
  @@index([servicePlanId])
  @@index([status])
  @@index([scheduledStart])
  @@index([clientId])
  @@index([addressId])
  @@index([leadId])
}

model Invoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  number   Int       @unique
  issuedAt DateTime  @default(now())
  dueAt    DateTime?

  totalCents      Int
  amountPaidCents Int @default(0)

  paidAt        DateTime?
  paymentMethod PaymentMethod?

  notes InvoiceNote[]

  payments Payment[]

  jobId String @unique
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([issuedAt])
  @@index([dueAt])
  @@index([paidAt])
}

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  status PaymentStatus @default(CREATED)

  amountCents Int
  currency    String @default("usd")

  method PaymentMethod?

  stripePaymentIntentId String  @unique
  stripeChargeId        String? @unique

  failureCode    String?
  failureMessage String?

  rawEventId String?

  @@index([invoiceId])
  @@index([createdAt])
  @@index([status])
}

model InvoiceNote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  channel InvoiceNoteChannel
  body    String

  createdByUserId String?

  @@index([invoiceId])
  @@index([createdAt])
  @@index([channel])
}

model ServicePlan {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status    ServicePlanStatus    @default(ACTIVE)
  frequency ServicePlanFrequency

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  addressId String?
  address   ClientAddress? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  title String
  notes String?

  startDate DateTime
  endDate   DateTime?

  dayOfWeek  Int?
  dayOfMonth Int?

  pricePerVisitCents Int?

  lastGeneratedAt DateTime?

  jobs Job[]

  // TODO: Autopay flags + scheduling later (cron + retries).

  @@index([clientId])
  @@index([status])
  @@index([frequency])
  @@index([startDate])
}

model Expense {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  occurredAt DateTime @default(now())

  category ExpenseCategory @default(OTHER)
  vendor   String?
  memo     String?

  amountCents Int

  jobId String?
  job   Job?    @relation(fields: [jobId], references: [id], onDelete: SetNull)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  createdByUserId String?

  @@index([occurredAt])
  @@index([category])
  @@index([jobId])
  @@index([clientId])
}
