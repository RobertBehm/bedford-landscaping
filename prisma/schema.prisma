// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum LeadStatus {
  NEW
  CONTACTED
  SCHEDULED
  COMPLETED
  ARCHIVED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskRecurrence {
  NONE
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum JobStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  DONE
  INVOICED
  PAID
  CANCELED
}

enum ServicePlanStatus {
  ACTIVE
  PAUSED
  CANCELED
}

enum ServicePlanFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum PaymentMethod {
  CASH
  CHECK
  CARD
  ACH
  OTHER
}

enum InvoiceNoteChannel {
  CALL
  TEXT
  EMAIL
  IN_PERSON
  OTHER
}

model Lead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name    String
  email   String?
  phone   String
  address String?
  city    String?
  state   String?
  zip     String?

  service String?
  message String

  status LeadStatus @default(NEW)

  sourceUrl String?

  customerUserId String?

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  notes LeadNote[]
  tasks Task[]
  jobs  Job[]

  @@index([createdAt])
  @@index([status])
  @@index([customerUserId])
  @@index([email])
  @@index([clientId])
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  authorId  String?
  body      String
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdAt])
}

model Task {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title    String
  body     String?
  dueAt    DateTime
  priority TaskPriority @default(MEDIUM)

  completedAt DateTime?

  recurrence TaskRecurrence @default(NONE)

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  createdByUserId String?

  @@index([dueAt])
  @@index([completedAt])
  @@index([priority])
  @@index([leadId])
  @@index([clientId])
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name  String
  email String?
  phone String?

  tags  String?
  notes String?

  leads        Lead[]
  addresses    ClientAddress[]
  tasks        Task[]
  jobs         Job[]
  servicePlans ServicePlan[] // ✅ opposite side for ServicePlan.client

  @@index([createdAt])
  @@index([name])
  @@index([email])
  @@index([phone])
}

model ClientAddress {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  label    String?
  address  String
  city     String?
  state    String?
  zip      String?
  gateCode String?
  notes    String?

  isPrimary Boolean @default(false)

  jobs         Job[]
  servicePlans ServicePlan[] // ✅ opposite side for ServicePlan.address

  @@index([clientId])
  @@index([isPrimary])
}

model Job {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status JobStatus @default(DRAFT)

  title String
  notes String?

  // scheduling
  scheduledStart DateTime?
  scheduledEnd   DateTime?

  // money
  estimatedPriceCents Int?
  actualPriceCents    Int?

  // relations
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  addressId String?
  address   ClientAddress? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  servicePlanId String?
  servicePlan   ServicePlan? @relation(fields: [servicePlanId], references: [id], onDelete: SetNull)
  // TODO: Invoicing model will likely need a different dedupe key (occurrenceId / rruleseq) later.

  invoice Invoice?

  @@unique([servicePlanId, scheduledStart])
  @@index([servicePlanId])
  @@index([status])
  @@index([scheduledStart])
  @@index([clientId])
  @@index([addressId])
  @@index([leadId])
}

model Invoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Business identifiers
  number   Int       @unique // simple incrementing integer
  issuedAt DateTime  @default(now())
  dueAt    DateTime?

  // Amounts
  totalCents      Int
  amountPaidCents Int @default(0)

  // Payment tracking (MVP)
  paidAt        DateTime?
  paymentMethod PaymentMethod?

  notes InvoiceNote[]

  // Relations (1 invoice per job for MVP)
  jobId String @unique
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([issuedAt])
  @@index([dueAt])
  @@index([paidAt])
}

model InvoiceNote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  channel InvoiceNoteChannel
  body    String

  createdByUserId String? // Clerk user id

  @@index([invoiceId])
  @@index([createdAt])
  @@index([channel])
}

model ServicePlan {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status    ServicePlanStatus    @default(ACTIVE)
  frequency ServicePlanFrequency

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  addressId String?
  address   ClientAddress? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  title String
  notes String?

  // Schedule anchor
  startDate DateTime
  endDate   DateTime?

  // Weekly/Biweekly: preferred day of week (0=Sunday..6=Saturday)
  dayOfWeek Int?

  // Monthly: day-of-month (1..31). If null, derived from startDate.
  dayOfMonth Int?

  // Price per visit (cents)
  pricePerVisitCents Int?

  // Used to avoid regenerating old dates repeatedly
  lastGeneratedAt DateTime?

  // Generated jobs (or manually linked jobs)
  jobs Job[]

  @@index([clientId])
  @@index([status])
  @@index([frequency])
  @@index([startDate])
}
